import React, { useState, useEffect } from 'react';
import { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts';
import Papa from 'papaparse';

const BudgetTracker = () => {
  const [transactions, setTransactions] = useState([]);
  const [timeView, setTimeView] = useState('month');
  const [selectedCategory, setSelectedCategory] = useState('all');
  const [loading, setLoading] = useState(true);
  const [categoryData, setCategoryData] = useState([]);
  const [timeSeriesData, setTimeSeriesData] = useState([]);
  const [importError, setImportError] = useState(null);

  const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d', '#ffc658', '#ff7c7c', '#8dd1e1', '#d084d0'];

  useEffect(() => {
    loadTransactions();
  }, []);

  useEffect(() => {
    if (transactions.length > 0) {
      processData();
    }
  }, [transactions, timeView, selectedCategory]);

  const loadTransactions = async () => {
    try {
      const fileContent = await window.fs.readFile('transactions11.csv', { encoding: 'utf8' });
      const parsed = Papa.parse(fileContent, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        delimitersToGuess: [',', '\t', '|', ';']
      });

      const processedTransactions = parsed.data.map(row => ({
        ...row,
        date: new Date(row['Transaction Date']),
        amount: row['Amount'] || 0,
        isDebit: row['Credit Debit Indicator'] === 'Debit',
        category: (row['Category'] || 'Uncategorized').trim()
      })).filter(t => t.date && !isNaN(t.date));

      setTransactions(processedTransactions);
      setLoading(false);
      setImportError(null);
    } catch (error) {
      console.error('Error loading transactions:', error);
      setLoading(false);
      setImportError('Could not load default file. Please import a CSV file.');
    }
  };

  const handleFileImport = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    setLoading(true);
    setImportError(null);

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const text = e.target.result;
        const parsed = Papa.parse(text, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          delimitersToGuess: [',', '\t', '|', ';']
        });

        const processedTransactions = parsed.data.map(row => ({
          ...row,
          date: new Date(row['Transaction Date']),
          amount: row['Amount'] || 0,
          isDebit: row['Credit Debit Indicator'] === 'Debit',
          category: (row['Category'] || 'Uncategorized').trim()
        })).filter(t => t.date && !isNaN(t.date));

        if (processedTransactions.length === 0) {
          setImportError('No valid transactions found in the file. Please check the format.');
          setLoading(false);
          return;
        }

        setTransactions(processedTransactions);
        setLoading(false);
        setImportError(null);
      } catch (error) {
        console.error('Error parsing CSV:', error);
        setImportError('Error parsing CSV file. Please check the file format.');
        setLoading(false);
      }
    };

    reader.onerror = () => {
      setImportError('Error reading file. Please try again.');
      setLoading(false);
    };

    reader.readAsText(file);
  };

  const processData = () => {
    const debits = transactions.filter(t => t.isDebit);
    const filtered = selectedCategory === 'all' 
      ? debits 
      : debits.filter(t => t.category === selectedCategory);

    // Category summary
    const categoryMap = {};
    debits.forEach(t => {
      if (!categoryMap[t.category]) {
        categoryMap[t.category] = 0;
      }
      categoryMap[t.category] += t.amount;
    });

    const catData = Object.entries(categoryMap)
      .map(([name, value]) => ({ name, value: parseFloat(value.toFixed(2)) }))
      .sort((a, b) => b.value - a.value);

    setCategoryData(catData);

    // Time series data
    const timeMap = {};
    
    filtered.forEach(t => {
      let key;
      if (timeView === 'year') {
        key = `${t.date.getFullYear()}-${String(t.date.getMonth() + 1).padStart(2, '0')}`;
      } else if (timeView === 'month') {
        const day = t.date.getDate();
        key = `${t.date.getFullYear()}-${String(t.date.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      } else {
        const startOfWeek = new Date(t.date);
        const dayOfWeek = startOfWeek.getDay();
        startOfWeek.setDate(startOfWeek.getDate() - dayOfWeek);
        key = startOfWeek.toISOString().split('T')[0];
      }

      if (!timeMap[key]) {
        timeMap[key] = 0;
      }
      timeMap[key] += t.amount;
    });

    const tsData = Object.entries(timeMap)
      .map(([period, amount]) => ({ 
        period, 
        amount: parseFloat(amount.toFixed(2)),
        displayPeriod: timeView === 'year' ? period : period
      }))
      .sort((a, b) => a.period.localeCompare(b.period));

    setTimeSeriesData(tsData);
  };

  const getTotalSpending = () => {
    return transactions
      .filter(t => t.isDebit && (selectedCategory === 'all' || t.category === selectedCategory))
      .reduce((sum, t) => sum + t.amount, 0)
      .toFixed(2);
  };

  const getDateRange = () => {
    if (transactions.length === 0) return { min: null, max: null, days: 0 };
    const dates = transactions.map(t => t.date);
    const min = new Date(Math.min(...dates));
    const max = new Date(Math.max(...dates));
    const days = Math.ceil((max - min) / (1000 * 60 * 60 * 24)) + 1;
    return { min, max, days };
  };

  const getAverageSpending = () => {
    const total = parseFloat(getTotalSpending());
    const { days } = getDateRange();
    
    if (days === 0) return '0.00';
    
    let divisor;
    if (timeView === 'year') {
      divisor = days / 30; // Average per month
    } else if (timeView === 'month') {
      divisor = days; // Average per day
    } else {
      divisor = days / 7; // Average per week
    }
    
    return divisor > 0 ? (total / divisor).toFixed(2) : '0.00';
  };

  const categories = ['all', ...new Set(transactions.filter(t => t.isDebit).map(t => t.category))];

  if (loading) {
    return (
      <div className="flex items-center justify-center h-screen bg-gray-50">
        <div className="text-xl text-gray-600">Loading transactions...</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
      <div className="max-w-7xl mx-auto">
        <header className="mb-8">
          <div className="flex justify-between items-start mb-4">
            <div>
              <h1 className="text-4xl font-bold text-gray-800 mb-2">Budget Tracker Dashboard</h1>
              <p className="text-gray-600">
                Track your spending across categories and time periods
                {transactions.length > 0 && (() => {
                  const { min, max, days } = getDateRange();
                  return ` â€¢ Data: ${min?.toLocaleDateString()} to ${max?.toLocaleDateString()} (${days} days)`;
                })()}
              </p>
            </div>
            <div className="flex flex-col items-end gap-2">
              <label className="cursor-pointer">
                <input
                  type="file"
                  accept=".csv"
                  onChange={handleFileImport}
                  className="hidden"
                />
                <div className="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg shadow-md transition flex items-center gap-2">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                  </svg>
                  Import CSV
                </div>
              </label>
              {importError && (
                <div className="text-red-600 text-sm bg-red-50 px-3 py-2 rounded">
                  {importError}
                </div>
              )}
            </div>
          </div>
        </header>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div className="bg-white rounded-lg shadow-md p-6">
            <div className="text-sm text-gray-500 mb-1">Total Spending</div>
            <div className="text-3xl font-bold text-red-600">${getTotalSpending()}</div>
          </div>
          <div className="bg-white rounded-lg shadow-md p-6">
            <div className="text-sm text-gray-500 mb-1">Average per {timeView === 'year' ? 'Month' : timeView === 'month' ? 'Day' : 'Week'}</div>
            <div className="text-3xl font-bold text-blue-600">${getAverageSpending()}</div>
            <div className="text-xs text-gray-400 mt-1">Based on actual date range</div>
          </div>
          <div className="bg-white rounded-lg shadow-md p-6">
            <div className="text-sm text-gray-500 mb-1">Total Transactions</div>
            <div className="text-3xl font-bold text-green-600">{transactions.filter(t => t.isDebit).length}</div>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
          <div className="flex flex-wrap gap-4 mb-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Time Period</label>
              <div className="flex gap-2">
                <button
                  onClick={() => setTimeView('week')}
                  className={`px-4 py-2 rounded-lg font-medium transition ${
                    timeView === 'week'
                      ? 'bg-blue-600 text-white'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  Week
                </button>
                <button
                  onClick={() => setTimeView('month')}
                  className={`px-4 py-2 rounded-lg font-medium transition ${
                    timeView === 'month'
                      ? 'bg-blue-600 text-white'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  Month
                </button>
                <button
                  onClick={() => setTimeView('year')}
                  className={`px-4 py-2 rounded-lg font-medium transition ${
                    timeView === 'year'
                      ? 'bg-blue-600 text-white'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  Year
                </button>
              </div>
            </div>

            <div className="flex-1 min-w-[200px]">
              <label className="block text-sm font-medium text-gray-700 mb-2">Category Filter</label>
              <select
                value={selectedCategory}
                onChange={(e) => setSelectedCategory(e.target.value)}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                {categories.map(cat => (
                  <option key={cat} value={cat}>
                    {cat === 'all' ? 'All Categories' : cat}
                  </option>
                ))}
              </select>
            </div>
          </div>

          <h2 className="text-xl font-bold text-gray-800 mb-4">Spending Over Time</h2>
          <ResponsiveContainer width="100%" height={400}>
            <LineChart data={timeSeriesData}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis 
                dataKey="period" 
                angle={-45}
                textAnchor="end"
                height={100}
                tick={{ fontSize: 12 }}
              />
              <YAxis />
              <Tooltip 
                formatter={(value) => `$${value}`}
                labelFormatter={(label) => `Period: ${label}`}
              />
              <Legend />
              <Line 
                type="monotone" 
                dataKey="amount" 
                stroke="#3b82f6" 
                strokeWidth={2}
                dot={{ r: 4 }}
                name="Spending ($)"
              />
            </LineChart>
          </ResponsiveContainer>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="bg-white rounded-lg shadow-md p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Spending by Category</h2>
            <ResponsiveContainer width="100%" height={400}>
              <PieChart>
                <Pie
                  data={categoryData.slice(0, 10)}
                  cx="50%"
                  cy="50%"
                  labelLine={false}
                  label={({name, percent}) => `${name}: ${(percent * 100).toFixed(0)}%`}
                  outerRadius={120}
                  fill="#8884d8"
                  dataKey="value"
                >
                  {categoryData.slice(0, 10).map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                  ))}
                </Pie>
                <Tooltip formatter={(value) => `$${value}`} />
              </PieChart>
            </ResponsiveContainer>
          </div>

          <div className="bg-white rounded-lg shadow-md p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Top 10 Categories</h2>
            <ResponsiveContainer width="100%" height={400}>
              <BarChart data={categoryData.slice(0, 10)}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis 
                  dataKey="name" 
                  angle={-45}
                  textAnchor="end"
                  height={120}
                  tick={{ fontSize: 11 }}
                />
                <YAxis />
                <Tooltip formatter={(value) => `$${value}`} />
                <Bar dataKey="value" fill="#3b82f6" name="Amount ($)" />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow-md p-6 mt-6">
          <h2 className="text-xl font-bold text-gray-800 mb-4">Category Breakdown</h2>
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="border-b-2 border-gray-300">
                  <th className="text-left py-3 px-4 font-semibold text-gray-700">Category</th>
                  <th className="text-right py-3 px-4 font-semibold text-gray-700">Total Spent</th>
                  <th className="text-right py-3 px-4 font-semibold text-gray-700">% of Total</th>
                </tr>
              </thead>
              <tbody>
                {categoryData.map((cat, idx) => {
                  const totalSpent = categoryData.reduce((sum, c) => sum + c.value, 0);
                  const percentage = ((cat.value / totalSpent) * 100).toFixed(1);
                  return (
                    <tr key={idx} className="border-b border-gray-200 hover:bg-gray-50">
                      <td className="py-3 px-4">{cat.name}</td>
                      <td className="py-3 px-4 text-right font-medium">${cat.value}</td>
                      <td className="py-3 px-4 text-right text-gray-600">{percentage}%</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
};

export default BudgetTracker;