<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Tracker Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(to bottom right, #eff6ff, #e0e7ff);
            min-height: 100vh;
            padding: 24px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: start;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-content h1 {
            font-size: 2.25rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .header-content p {
            color: #6b7280;
        }

        .import-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .btn-import {
            background: #2563eb;
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background 0.2s;
        }

        .btn-import:hover {
            background: #1d4ed8;
        }

        .error-msg {
            color: #dc2626;
            background: #fee2e2;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .success-msg {
            color: #16a34a;
            background: #dcfce7;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .month-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .month-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .month-btn:hover {
            border-color: #2563eb;
        }

        .month-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 24px;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stat-value.positive { color: #16a34a; }
        .stat-value.negative { color: #dc2626; }
        .stat-value.neutral { color: #2563eb; }

        .stat-note {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
        }

        h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 20px;
        }

        .budget-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
        }

        .budget-table thead {
            background: #f3f4f6;
        }

        .budget-table th {
            text-align: left;
            padding: 12px 16px;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #d1d5db;
        }

        .budget-table th.right {
            text-align: right;
        }

        .budget-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .budget-table td.right {
            text-align: right;
            font-weight: 500;
        }

        .budget-table tbody tr:hover {
            background: #f9fafb;
        }

        .budget-table .category-name {
            font-weight: 500;
        }

        .budget-table .total-row {
            background: #f3f4f6;
            font-weight: 600;
        }

        .income-section {
            border-left: 4px solid #16a34a;
        }

        .expense-section {
            border-left: 4px solid #dc2626;
        }

        .positive-value {
            color: #16a34a;
        }

        .negative-value {
            color: #dc2626;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 16px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            height: 100vh;
            gap: 16px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #16a34a, #22c55e);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .progress-fill.over-budget {
            background: linear-gradient(90deg, #dc2626, #ef4444);
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div style="font-size: 1.25rem; color: #6b7280;">Please import an Excel file to get started</div>
    </div>
    
    <div id="app" class="container" style="display: none;">
        <div class="header">
            <div class="header-content">
                <h1>Budget Tracker Dashboard</h1>
                <p id="header-info">Import your budget Excel file to view insights</p>
            </div>
            <div class="import-section">
                <label for="fileInput" class="btn-import">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    Import Excel File
                </label>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                <div id="error-msg" class="error-msg" style="display: none;"></div>
                <div id="success-msg" class="success-msg" style="display: none;"></div>
            </div>
        </div>

        <div class="month-selector" id="month-selector"></div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Income</div>
                <div class="stat-value positive" id="total-income">$0.00</div>
                <div class="stat-note">For selected period</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Expenses</div>
                <div class="stat-value negative" id="total-expenses">$0.00</div>
                <div class="stat-note">For selected period</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Net Income</div>
                <div class="stat-value neutral" id="net-income">$0.00</div>
                <div class="stat-note">Income minus expenses</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Budget vs Actual</div>
                <div class="stat-value neutral" id="budget-variance">$0.00</div>
                <div class="stat-note" id="budget-note">Under budget</div>
            </div>
        </div>

        <div class="card income-section">
            <h2>Income</h2>
            <table class="budget-table" id="income-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th class="right">Actual</th>
                        <th class="right">Budgeted</th>
                        <th class="right">Variance</th>
                        <th class="right">% of Budget</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="card expense-section">
            <h2>Expenses</h2>
            <table class="budget-table" id="expense-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th class="right">Actual</th>
                        <th class="right">Budgeted</th>
                        <th class="right">Variance</th>
                        <th class="right">% of Budget</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="charts-grid">
            <div class="card">
                <h2>Monthly Spending Trends</h2>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2>Expense Breakdown</h2>
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Budget Performance by Category</h2>
            <div class="chart-container">
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let budgetData = {
            transactions: [],
            income: [],
            expenses: [],
            months: []
        };
        let selectedMonth = 'all';
        let charts = { monthly: null, pie: null, bar: null };

        function showMessage(message, isError = false) {
            const errorDiv = document.getElementById('error-msg');
            const successDiv = document.getElementById('success-msg');
            
            if (isError) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
                setTimeout(() => errorDiv.style.display = 'none', 5000);
            } else {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                errorDiv.style.display = 'none';
                setTimeout(() => successDiv.style.display = 'none', 3000);
            }
        }

        async function loadExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        resolve(workbook);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function parseExcelData(workbook) {
            // Parse Log sheet for transactions
            const logSheet = workbook.Sheets['Log'];
            if (!logSheet) {
                throw new Error('Log sheet not found in Excel file');
            }

            const logData = XLSX.utils.sheet_to_json(logSheet, { header: 1, defval: null });
            const transactions = logData
                .filter(row => row[0] && row[1] && row[2])
                .slice(1)
                .map(row => ({
                    month: row[0],
                    date: row[1] instanceof Date ? row[1] : new Date(row[1]),
                    description: row[2],
                    category: row[3] || 'Uncategorized',
                    income: row[4] || 0,
                    debit: row[5] || 0
                }));

            // Parse Dashboard sheet for budget data
            const dashboardSheet = workbook.Sheets['Dashboard'];
            if (!dashboardSheet) {
                throw new Error('Dashboard sheet not found in Excel file');
            }

            const dashboardData = XLSX.utils.sheet_to_json(dashboardSheet, { header: 1, defval: null });
            
            const income = [];
            const expenses = [];
            let isIncomeSection = false;
            let isExpenseSection = false;

            dashboardData.forEach((row, idx) => {
                if (row[0] === 'Income') {
                    isIncomeSection = true;
                    isExpenseSection = false;
                    return;
                } else if (row[0] === 'Debit') {
                    isIncomeSection = false;
                    isExpenseSection = true;
                    return;
                } else if (row[0] === 'Total') {
                    return;
                }

                if (isIncomeSection && row[0] && row[0] !== 'Income' && typeof row[1] === 'number') {
                    income.push({
                        category: row[0],
                        actual: row[1] || 0,
                        budgeted: row[2] || 0,
                        months: row.slice(5, 17)
                    });
                } else if (isExpenseSection && row[0] && row[0] !== 'Debit' && typeof row[1] === 'number') {
                    expenses.push({
                        category: row[0],
                        actual: Math.abs(row[1] || 0),
                        budgeted: Math.abs(row[2] || 0),
                        months: row.slice(5, 17).map(v => Math.abs(v || 0))
                    });
                }
            });

            return { transactions, income, expenses };
        }

        function getUniqueMonths(transactions) {
            const months = [...new Set(transactions.map(t => t.month))];
            const monthOrder = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            return months.sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
        }

        function filterByMonth(data, month) {
            if (month === 'all') return data;
            return data.filter(item => item.month === month);
        }

        function updateMonthSelector() {
            const selector = document.getElementById('month-selector');
            const months = ['all', ...budgetData.months];
            
            selector.innerHTML = months.map(month => `
                <button class="month-btn ${month === selectedMonth ? 'active' : ''}" 
                        onclick="selectMonth('${month}')">
                    ${month === 'all' ? 'Year to Date' : month}
                </button>
            `).join('');
        }

        function selectMonth(month) {
            selectedMonth = month;
            updateUI();
        }

        function updateStats() {
            let income = budgetData.income;
            let expenses = budgetData.expenses;

            if (selectedMonth !== 'all') {
                const monthIndex = ['January', 'February', 'March', 'April', 'May', 'June',
                                   'July', 'August', 'September', 'October', 'November', 'December']
                                   .indexOf(selectedMonth);
                
                income = budgetData.income.map(item => ({
                    ...item,
                    actual: item.months[monthIndex] || 0
                }));
                
                expenses = budgetData.expenses.map(item => ({
                    ...item,
                    actual: item.months[monthIndex] || 0
                }));
            }

            const totalIncome = income.reduce((sum, item) => sum + item.actual, 0);
            const totalExpenses = expenses.reduce((sum, item) => sum + item.actual, 0);
            const netIncome = totalIncome - totalExpenses;
            
            const budgetedExpenses = expenses.reduce((sum, item) => sum + item.budgeted, 0);
            const variance = budgetedExpenses - totalExpenses;

            document.getElementById('total-income').textContent = '$' + totalIncome.toFixed(2);
            document.getElementById('total-expenses').textContent = '$' + totalExpenses.toFixed(2);
            document.getElementById('net-income').textContent = '$' + netIncome.toFixed(2);
            document.getElementById('net-income').className = 'stat-value ' + (netIncome >= 0 ? 'positive' : 'negative');
            
            document.getElementById('budget-variance').textContent = '$' + Math.abs(variance).toFixed(2);
            document.getElementById('budget-variance').className = 'stat-value ' + (variance >= 0 ? 'positive' : 'negative');
            document.getElementById('budget-note').textContent = variance >= 0 ? 'Under budget' : 'Over budget';

            const dateRange = selectedMonth === 'all' ? 'Year to Date' : selectedMonth;
            document.getElementById('header-info').textContent = `Viewing: ${dateRange} • ${budgetData.transactions.length} transactions loaded`;
        }

        function updateTables() {
            let income = budgetData.income;
            let expenses = budgetData.expenses;

            if (selectedMonth !== 'all') {
                const monthIndex = ['January', 'February', 'March', 'April', 'May', 'June',
                                   'July', 'August', 'September', 'October', 'November', 'December']
                                   .indexOf(selectedMonth);
                
                income = budgetData.income.map(item => ({
                    ...item,
                    actual: item.months[monthIndex] || 0
                }));
                
                expenses = budgetData.expenses.map(item => ({
                    ...item,
                    actual: item.months[monthIndex] || 0
                }));
            }

            // Income table
            const incomeBody = document.querySelector('#income-table tbody');
            const totalIncome = income.reduce((sum, item) => sum + item.actual, 0);
            const totalBudgetedIncome = income.reduce((sum, item) => sum + item.budgeted, 0);
            
            incomeBody.innerHTML = income.map(item => {
                const variance = item.actual - item.budgeted;
                const pct = item.budgeted > 0 ? (item.actual / item.budgeted * 100) : 0;
                return `
                    <tr>
                        <td class="category-name">${item.category}</td>
                        <td class="right positive-value">$${item.actual.toFixed(2)}</td>
                        <td class="right">$${item.budgeted.toFixed(2)}</td>
                        <td class="right ${variance >= 0 ? 'positive-value' : 'negative-value'}">
                            $${Math.abs(variance).toFixed(2)} ${variance >= 0 ? '▲' : '▼'}
                        </td>
                        <td class="right">${pct.toFixed(1)}%</td>
                    </tr>
                `;
            }).join('') + `
                <tr class="total-row">
                    <td>Total Income</td>
                    <td class="right">$${totalIncome.toFixed(2)}</td>
                    <td class="right">$${totalBudgetedIncome.toFixed(2)}</td>
                    <td class="right">$${Math.abs(totalIncome - totalBudgetedIncome).toFixed(2)}</td>
                    <td class="right">${totalBudgetedIncome > 0 ? (totalIncome / totalBudgetedIncome * 100).toFixed(1) : 0}%</td>
                </tr>
            `;

            //
