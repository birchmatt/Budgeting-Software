<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Budget Tracker</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #eff6ff, #e0e7ff); min-height: 100vh; padding: 24px; }
.container { max-width: 1400px; margin: 0 auto; }
.header { margin-bottom: 32px; display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 16px; }
.header h1 { font-size: 2rem; font-weight: bold; color: #1f2937; }
.header p { color: #6b7280; font-size: 0.875rem; }
.btn-import { background: #2563eb; color: white; font-weight: 600; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
.btn-import:hover { background: #1d4ed8; }
.message { padding: 8px 12px; border-radius: 6px; font-size: 0.875rem; margin-top: 8px; }
.error { color: #dc2626; background: #fee2e2; }
.success { color: #16a34a; background: #dcfce7; }
.controls { background: white; border-radius: 12px; padding: 20px; margin-bottom: 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.control-row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
.control-row:last-child { margin-bottom: 0; }
.control-label { font-weight: 600; color: #374151; min-width: 100px; }
.view-btn, .period-btn { padding: 8px 16px; border-radius: 6px; border: 2px solid #e5e7eb; background: white; cursor: pointer; font-size: 0.875rem; transition: all 0.2s; }
.view-btn:hover, .period-btn:hover { border-color: #2563eb; }
.view-btn.active, .period-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
.nav-btn { padding: 8px 12px; border-radius: 6px; border: 1px solid #d1d5db; background: white; cursor: pointer; }
.nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px; }
.stat-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.stat-label { font-size: 0.875rem; color: #6b7280; margin-bottom: 8px; }
.stat-value { font-size: 1.75rem; font-weight: bold; margin-bottom: 4px; }
.stat-value.negative { color: #dc2626; }
.stat-value.neutral { color: #2563eb; }
.stat-note { font-size: 0.75rem; color: #9ca3af; }
.card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.card.expense { border-left: 4px solid #dc2626; }
h2 { font-size: 1.25rem; font-weight: bold; color: #1f2937; margin-bottom: 16px; }
table { width: 100%; border-collapse: collapse; }
thead { background: #f3f4f6; }
th { text-align: left; padding: 12px; font-weight: 600; color: #374151; border-bottom: 2px solid #d1d5db; }
th.right { text-align: right; }
td { padding: 12px; border-bottom: 1px solid #e5e7eb; }
td.right { text-align: right; }
tbody tr:hover { background: #f9fafb; }
.total-row { background: #f3f4f6; font-weight: 600; }
.negative-value { color: #dc2626; }
.chart-container { position: relative; height: 400px; }
.charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 24px; }
.loading { display: flex; align-items: center; justify-content: center; flex-direction: column; height: 100vh; gap: 16px; }
.hidden { display: none !important; }
</style>
</head>
<body>

<div id="loading" class="loading">
<p style="font-size: 1.25rem; color: #6b7280; margin-bottom: 24px;">Import CSV to get started</p>
<input type="file" id="fileInputLoading" accept=".csv" style="display: none;">
<label for="fileInputLoading" class="btn-import">Import CSV File</label>
</div>

<div id="app" class="container hidden">
<div class="header">
<div><h1>Budget Tracker</h1><p id="info">No data loaded</p></div>
<div><input type="file" id="fileInput" accept=".csv" style="display: none;"><label for="fileInput" class="btn-import">Import CSV</label><div id="msg"></div></div>
</div>

<div class="controls">
<div class="control-row">
<span class="control-label">View:</span>
<button class="view-btn" onclick="app.setView('day')">Day</button>
<button class="view-btn" onclick="app.setView('week')">Week</button>
<button class="view-btn active" onclick="app.setView('month')">Month</button>
<button class="view-btn" onclick="app.setView('year')">Year</button>
<button class="view-btn" onclick="app.setView('all')">All</button>
</div>
<div class="control-row hidden" id="periodRow">
<span class="control-label" id="periodLabel">Period:</span>
<button class="nav-btn" id="prevBtn" onclick="app.navigate(-1)">← Prev</button>
<button class="nav-btn" id="nextBtn" onclick="app.navigate(1)">Next →</button>
<div id="periodBtns" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
</div>
</div>

<div class="stats-grid">
<div class="stat-card"><div class="stat-label">Total Spending</div><div class="stat-value negative" id="totalSpend">$0</div><div class="stat-note" id="periodNote">-</div></div>
<div class="stat-card"><div class="stat-label">Avg per Day</div><div class="stat-value neutral" id="avgSpend">$0</div><div class="stat-note">Based on period</div></div>
<div class="stat-card"><div class="stat-label">Transactions</div><div class="stat-value neutral" id="txCount">0</div><div class="stat-note">Debit only</div></div>
<div class="stat-card"><div class="stat-label">Date Range</div><div class="stat-value neutral" style="font-size: 1.125rem;" id="dateRange">-</div><div class="stat-note" id="daysNote">-</div></div>
</div>

<div class="card expense">
<h2>Spending by Category</h2>
<table><thead><tr><th>Category</th><th class="right">Total</th><th class="right">Count</th><th class="right">%</th><th class="right">Avg</th></tr></thead><tbody id="catTable"></tbody></table>
</div>

<div class="charts-grid">
<div class="card"><h2>Spending Over Time</h2><div class="chart-container"><canvas id="timeChart"></canvas></div></div>
<div class="card"><h2>Category Breakdown</h2><div class="chart-container"><canvas id="pieChart"></canvas></div></div>
</div>

<div class="card"><h2>Top 10 Categories</h2><div class="chart-container"><canvas id="barChart"></canvas></div></div>
</div>

<script>
console.log('Starting app...');

const app = {
  data: [], filtered: [], view: 'month', period: null, periods: [],
  charts: { time: null, pie: null, bar: null },
  
  init() {
    console.log('Init app');
    document.getElementById('fileInputLoading').onchange = e => this.load(e);
    document.getElementById('fileInput').onchange = e => this.load(e);
  },
  
  load(e) {
    console.log('File selected');
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => this.parse(ev.target.result);
    reader.readAsText(file);
  },
  
  parse(text) {
    console.log('Parsing CSV');
    Papa.parse(text, {
      header: true, dynamicTyping: true, skipEmptyLines: true,
      complete: r => {
        this.data = r.data.filter(row => row['Transaction Date'] && row['Credit Debit Indicator'] === 'Debit').map(row => ({
          date: new Date(row['Transaction Date']),
          amount: Math.abs(row['Amount'] || 0),
          category: (row['Category'] || 'Other').trim()
        })).filter(t => !isNaN(t.date.getTime()));
        console.log('Loaded', this.data.length, 'transactions');
        if (this.data.length === 0) { this.showMsg('No transactions found', true); return; }
        this.showMsg('Loaded ' + this.data.length + ' transactions');
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        this.setView('month');
      }
    });
  },
  
  showMsg(txt, err) {
    const div = document.getElementById('msg');
    div.className = 'message ' + (err ? 'error' : 'success');
    div.textContent = txt;
    setTimeout(() => div.textContent = '', 4000);
  },
  
  setView(v) {
    console.log('View:', v);
    this.view = v;
    this.period = null;
    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    if (v !== 'all' && v !== 'year') {
      this.makePeriods();
      document.getElementById('periodRow').classList.remove('hidden');
    } else {
      document.getElementById('periodRow').classList.add('hidden');
    }
    this.filter();
    this.update();
  },
  
  makePeriods() {
    const s = new Set();
    this.data.forEach(t => {
      let k;
      if (this.view === 'day') k = t.date.toISOString().split('T')[0];
      else if (this.view === 'week') { const d = new Date(t.date); d.setDate(d.getDate() - d.getDay()); k = d.toISOString().split('T')[0]; }
      else if (this.view === 'month') k = t.date.getFullYear() + '-' + String(t.date.getMonth() + 1).padStart(2, '0');
      if (k) s.add(k);
    });
    this.periods = Array.from(s).sort();
    if (this.periods.length > 0) this.period = this.periods[this.periods.length - 1];
  },
  
  setPeriod(p) {
    this.period = p;
    this.filter();
    this.update();
  },
  
  navigate(dir) {
    const i = this.periods.indexOf(this.period);
    const n = i + dir;
    if (n >= 0 && n < this.periods.length) {
      this.period = this.periods[n];
      this.filter();
      this.update();
    }
  },
  
  filter() {
    if (this.view === 'all' || this.view === 'year') { this.filtered = this.data; return; }
    if (!this.period) { this.filtered = this.data; return; }
    this.filtered = this.data.filter(t => {
      let k;
      if (this.view === 'day') k = t.date.toISOString().split('T')[0];
      else if (this.view === 'week') { const d = new Date(t.date); d.setDate(d.getDate() - d.getDay()); k = d.toISOString().split('T')[0]; }
      else if (this.view === 'month') k = t.date.getFullYear() + '-' + String(t.date.getMonth() + 1).padStart(2, '0');
      return k === this.period;
    });
  },
  
  update() {
    this.updatePeriods();
    this.updateStats();
    this.updateTable();
    this.updateCharts();
  },
  
  updatePeriods() {
    if (this.view === 'all' || this.view === 'year') return;
    const div = document.getElementById('periodBtns');
    div.innerHTML = this.periods.map(p => '<button class="period-btn ' + (p === this.period ? 'active' : '') + '" onclick="app.setPeriod(\'' + p + '\')">' + this.fmtPeriod(p) + '</button>').join('');
    const i = this.periods.indexOf(this.period);
    document.getElementById('prevBtn').disabled = i <= 0;
    document.getElementById('nextBtn').disabled = i >= this.periods.length - 1;
  },
  
  fmtPeriod(k) {
    if (this.view === 'day') return new Date(k).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
    if (this.view === 'month') { const p = k.split('-'); return new Date(p[0], p[1]-1).toLocaleDateString('en-US', {month: 'long', year: 'numeric'}); }
    if (this.view === 'week') { const s = new Date(k); const e = new Date(s); e.setDate(e.getDate() + 6); return s.toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) + ' - ' + e.toLocaleDateString('en-US', {month: 'short', day: 'numeric'}); }
    return k;
  },
  
  updateStats() {
    const tot = this.filtered.reduce((s, t) => s + t.amount, 0);
    const dates = this.filtered.map(t => t.date);
    const min = dates.length > 0 ? new Date(Math.min(...dates)) : null;
    const max = dates.length > 0 ? new Date(Math.max(...dates)) : null;
    const days = min && max ? Math.ceil((max - min) / 86400000) + 1 : 0;
    const avg = days > 0 ? tot / days : 0;
    document.getElementById('totalSpend').textContent = '$' + tot.toFixed(2);
    document.getElementById('avgSpend').textContent = '$' + avg.toFixed(2);
    document.getElementById('txCount').textContent = this.filtered.length;
    if (min && max) {
      document.getElementById('dateRange').textContent = min.toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) + ' - ' + max.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
      document.getElementById('daysNote').textContent = days + ' day' + (days !== 1 ? 's' : '');
    }
    document.getElementById('periodNote').textContent = this.period ? this.fmtPeriod(this.period) : 'All time';
    document.getElementById('info').textContent = this.data.length + ' total • Viewing: ' + (this.period ? this.fmtPeriod(this.period) : 'All');
  },
  
  updateTable() {
    const m = {};
    this.filtered.forEach(t => { if (!m[t.category]) m[t.category] = {tot: 0, cnt: 0}; m[t.category].tot += t.amount; m[t.category].cnt++; });
    const cats = Object.entries(m).map(([n, d]) => ({name: n, tot: d.tot, cnt: d.cnt, avg: d.tot/d.cnt})).sort((a,b) => b.tot - a.tot);
    const tot = cats.reduce((s, c) => s + c.tot, 0);
    const rows = cats.map(c => '<tr><td>' + c.name + '</td><td class="right negative-value">$' + c.tot.toFixed(2) + '</td><td class="right">' + c.cnt + '</td><td class="right">' + (tot > 0 ? (c.tot/tot*100).toFixed(1) : 0) + '%</td><td class="right">$' + c.avg.toFixed(2) + '</td></tr>').join('');
    const totalRow = '<tr class="total-row"><td>Total</td><td class="right">$' + tot.toFixed(2) + '</td><td class="right">' + this.filtered.length + '</td><td class="right">100%</td><td class="right">$' + (this.filtered.length > 0 ? (tot/this.filtered.length).toFixed(2) : '0.00') + '</td></tr>';
    document.getElementById('catTable').innerHTML = rows + totalRow;
  },
  
  updateCharts() {
    const tm = {};
    this.filtered.forEach(t => {
      let k;
      if (this.view === 'year' || this.view === 'all') k = t.date.getFullYear() + '-' + String(t.date.getMonth() + 1).padStart(2, '0');
      else if (this.view === 'month' || this.view === 'week') k = t.date.toISOString().split('T')[0];
      else if (this.view === 'day') k = String(t.date.getHours()).padStart(2, '0') + ':00';
      if (!tm[k]) tm[k] = 0;
      tm[k] += t.amount;
    });
    const td = Object.entries(tm).map(([p, a]) => ({p, a})).sort((a,b) => a.p.localeCompare(b.p));
    
    const cm = {};
    this.filtered.forEach(t => { if (!cm[t.category]) cm[t.category] = 0; cm[t.category] += t.amount; });
    const cd = Object.entries(cm).map(([n, t]) => ({n, t})).sort((a,b) => b.t - a.t);
    const top = cd.slice(0, 10);
    
    if (this.charts.time) this.charts.time.destroy();
    this.charts.time = new Chart(document.getElementById('timeChart'), {
      type: 'line',
      data: { labels: td.map(d => d.p), datasets: [{ label: 'Spending', data: td.map(d => d.a), borderColor: '#dc2626', backgroundColor: 'rgba(220,38,38,0.1)', fill: true }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { callbacks: { label: c => '$' + c.parsed.y.toFixed(2) } } }, scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + v } } } }
    });
    
    if (this.charts.pie) this.charts.pie.destroy();
    this.charts.pie = new Chart(document.getElementById('pieChart'), {
      type: 'pie',
      data: { labels: top.map(d => d.n), datasets: [{ data: top.map(d => d.t), backgroundColor: ['#0088FE','#00C49F','#FFBB28','#FF8042','#8884d8','#82ca9d','#ffc658','#ff7c7c','#8dd1e1','#d084d0'] }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }, tooltip: { callbacks: { label: c => c.label + ': $' + c.parsed.toFixed(2) } } } }
    });
    
    if (this.charts.bar) this.charts.bar.destroy();
    this.charts.bar = new Chart(document.getElementById('barChart'), {
      type: 'bar',
      data: { labels: top.map(d => d.n), datasets: [{ label: 'Amount', data: top.map(d => d.t), backgroundColor: '#dc2626' }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + v } } } }
    });
  }
};

window.addEventListener('DOMContentLoaded', () => { console.log('DOM ready'); app.init(); });
console.log('Script loaded');
</script>
</body>
</html>
